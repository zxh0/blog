# Lua 5.4ä¹‹äºŒè¿›åˆ¶å—æ ¼å¼

Lua 5.4å·²ç»äº2020å¹´6æœˆ29æ—¥æ­£å¼å‘å¸ƒäº†ï¼Œç›®å‰Luaçš„æœ€æ–°ç‰ˆæ˜¯äº2020å¹´10æœˆ9æ—¥å‘å¸ƒçš„5.4.1ã€‚å…³äºLua 5.4ä¸»è¦çš„æ–°ç‰¹æ€§å¯ä»¥çœ‹[è¿™é‡Œ](http://www.lua.org/manual/5.4/readme.html#changes)ï¼Œè¿™ä¸€ç³»åˆ—æ–‡ç« ä¸»è¦ä»‹ç»Luaå†…éƒ¨å®ç°çš„å˜åŒ–ã€‚æœ¬æ–‡æ˜¯è¿™ä¸€ç³»åˆ—çš„ç¬¬ä¸€ç¯‡æ–‡ç« ï¼Œå°†é‡ç‚¹ä»‹ç»LuaäºŒè¿›åˆ¶å—æ ¼å¼çš„å˜åŒ–ã€‚Luaè™šæ‹Ÿæœºã€æŒ‡ä»¤é›†ã€æŒ‡ä»¤æ ¼å¼ç­‰å˜åŒ–å°†åœ¨åç»­æ–‡ç« ä¸­ä»‹ç»ã€‚Luaè¯­è¨€æœ‰å¾ˆå¤šå®ç°ï¼Œä¾‹å¦‚å®˜æ–¹å®ç°ã€[LuaJIT](https://luajit.org/)ç­‰ï¼Œæœ¬ç³»åˆ—æ–‡ç« ä»…è®¨è®ºLuaå®˜æ–¹å®ç°ã€‚æœ¬ç³»åˆ—æ–‡ç« å‡å®šè¯»è€…å·²ç»ç†Ÿæ‚‰Lua 5.3äºŒè¿›åˆ¶å—æ ¼å¼ï¼Œå¹¶ä¸”äº†è§£[Javaç±»æ–‡ä»¶](https://docs.oracle.com/javase/specs/jvms/se15/html/jvms-4.html)æˆ–è€…[WebAssemblyæ¨¡å—](https://webassembly.github.io/spec/core/binary/index.html)ç­‰äºŒè¿›åˆ¶æ ¼å¼ã€‚å¦‚æœè¯»è€…å¯¹è¿™äº›æŠ€æœ¯è¿˜ä¸å¤ªäº†è§£ï¼Œå¯ä»¥å‚è€ƒæ–‡æœ«ç»™å‡ºçš„å­¦ä¹ èµ„æ–™ã€‚



## LuaäºŒè¿›åˆ¶å—

è™½ç„¶Luaæ˜¯è„šæœ¬è¯­è¨€ï¼Œä½†æ˜¯å’ŒPythonã€Rubyç­‰è„šæœ¬è¯­è¨€ç±»ä¼¼ï¼ŒLuaå®ç°ä¹Ÿæ˜¯å…ˆæŠŠè„šæœ¬ç¼–è¯‘æˆäºŒè¿›åˆ¶çš„å†…éƒ¨æ ¼å¼ï¼Œç„¶åå†äº¤ç»™Luaè™šæ‹Ÿæœºæ¥æ‰§è¡Œã€‚é€šå¸¸æˆ‘ä»¬ä½¿ç”¨`lua`å‘½ä»¤ç›´æ¥æ‰§è¡Œæ–‡æœ¬æ ¼å¼çš„Luaè„šæœ¬å³å¯ï¼Œç¼–è¯‘è¿‡ç¨‹å®Œå…¨è¢«éšè—äº†èµ·æ¥ã€‚ä½†æ˜¯Luaå‘è¡Œç‰ˆä¹Ÿæä¾›äº†`luac`å‘½ä»¤ï¼Œå¯ä»¥å°†è„šæœ¬ç¼–è¯‘æˆäºŒè¿›åˆ¶æ ¼å¼å¹¶ä¿å­˜ä¸ºç£ç›˜æ–‡ä»¶ã€‚åœ¨Luaçš„æœ¯è¯­ä¸­ï¼Œè„šæœ¬çš„ç¼–è¯‘å•ä½å«åšå—ï¼ˆChunkï¼‰ã€‚ç›¸åº”çš„ï¼Œç¼–è¯‘åçš„äºŒè¿›åˆ¶æ ¼å¼å«åšäºŒè¿›åˆ¶å—ï¼ˆBinary Chunkï¼‰ã€‚



## åŸºæœ¬æ•°æ®ç±»å‹

å’Œä»»ä½•äºŒè¿›åˆ¶æ ¼å¼ï¼ˆä¾‹å¦‚Javaç±»æ–‡ä»¶æ ¼å¼ã€WebAssemblyæ¨¡å—äºŒè¿›åˆ¶æ ¼å¼ç­‰ï¼‰ä¸€æ ·ï¼Œæœ¬è´¨ä¸Šï¼ŒLuaäºŒè¿›åˆ¶å—å°±æ˜¯ä¸€ä¸ªå­—èŠ‚æµï¼ˆæˆ–è€…å­—èŠ‚æ•°ç»„ï¼‰ã€‚åœ¨è¿™ä¸ªå­—èŠ‚æµå†…éƒ¨ï¼Œè¿ç»­Nä¸ªå­—èŠ‚å¯ä»¥æ„æˆæ›´å¤§ä¸€äº›çš„åŸºæœ¬æ•°æ®ç±»å‹ï¼Œä¾‹å¦‚æ•´æ•°ã€æµ®ç‚¹æ•°ç­‰ã€‚åŸºæœ¬æ•°æ®ç±»å‹å¯ä»¥æ„æˆæ›´å¤æ‚çš„æ•°æ®ç»“æ„ï¼Œä¾‹å¦‚å­—ç¬¦ä¸²ã€åˆ—è¡¨ç­‰ã€‚åŸºæœ¬æ•°æ®ç±»å‹å’Œæ•°æ®ç»“æ„åˆå¯ä»¥æ„æˆæ›´å¤æ‚çš„ç»“æ„ï¼Œæœ€ç»ˆæ„æˆæ•´ä¸ªäºŒè¿›åˆ¶å—ã€‚ä¸‹è¡¨åˆ—å‡ºäº†Lua 5.3å’Œ5.4äºŒè¿›åˆ¶æ ¼å¼çš„åŸºæœ¬æ•°æ®ç±»å‹ï¼š

| æ•°æ®ç±»å‹    | Lua 5.3 | Lua 5.4 | é•¿åº¦                |
| ----------- | ------- | ------- | ------------------- |
| byte        | âœ“       | âœ“       | 1å­—èŠ‚               |
| int         | âœ“       |         | æœºå™¨ç›¸å…³            |
| size_t      | âœ“       |         | æœºå™¨ç›¸å…³            |
| varint      |         | âœ“       | å˜é•¿                |
| lua_Integer | âœ“       | âœ“       | é€šå¸¸ä¸º8å­—èŠ‚ï¼Œå¯é…ç½® |
| lua_Number  | âœ“       | âœ“       | é€šå¸¸ä¸º8å­—èŠ‚ï¼Œå¯é…ç½® |
| Instruction | âœ“       | âœ“       | 4å­—èŠ‚               |

ä¸»è¦è¯´æ˜å‡ ç‚¹ã€‚ç¬¬ä¸€ï¼Œ`int`ã€`lua_Integer`ã€`lua_Number`ç­‰åŸºæœ¬ç±»å‹å±äºå®šé•¿ç±»å‹ï¼Œåœ¨å­—èŠ‚æµä¸­ç”±å›ºå®šæ•°é‡çš„è¿ç»­å¤šä¸ªå­—èŠ‚æ„æˆã€‚è¿™äº›å­—èŠ‚å¦‚ä½•æ’åˆ—è‡³å…³é‡è¦ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬æ‰€ç†ŸçŸ¥çš„[å­—èŠ‚åº](https://en.wikipedia.org/wiki/Endianness)é—®é¢˜ã€‚ä¸ºäº†ä¿è¯å¹³å°æ— å…³æ€§ï¼ŒJavaç±»æ–‡ä»¶æ ¼å¼å’ŒWebAssemblyæ¨¡å—äºŒè¿›åˆ¶æ ¼å¼éƒ½å¯¹å­—èŠ‚åºè¿›è¡Œäº†çº¦å®šã€‚Javaç±»æ–‡ä»¶é‡‡ç”¨å¤§ç«¯ï¼ˆBig-endianï¼‰å­—èŠ‚åºï¼ŒWebAssemblyäºŒè¿›åˆ¶æ¨¡å—åˆ™é‡‡ç”¨å°ç«¯ï¼ˆLittle-endianï¼‰å­—èŠ‚åºã€‚LuaäºŒè¿›åˆ¶å—çš„è®¾è®¡å®Œå…¨æ²¡æœ‰è€ƒè™‘è·¨å¹³å°ï¼Œå› æ­¤ç›´æ¥ä½¿ç”¨äº†æœºå™¨çš„å­—èŠ‚åºã€‚æ­¤å¤–ï¼Œé™¤äº†`byte`å’Œ`Instruction`ç±»å‹ï¼Œå®šé•¿æ•°æ®ç±»å‹çš„é•¿åº¦ä¹Ÿå¹¶éå®Œå…¨å›ºå®šï¼Œè€Œæ˜¯æœºå™¨ç›¸å…³æˆ–ç¼–è¯‘æ—¶å¯é…ç½®çš„ã€‚

ç¬¬äºŒï¼ŒLua 5.3äºŒè¿›åˆ¶æ ¼å¼å¹¶æ²¡æœ‰è€ƒè™‘ç´§å‡‘æ€§ï¼Œå› æ­¤æ‰€æœ‰åŸºæœ¬æ•°æ®ç±»å‹éƒ½æ˜¯å®šé•¿ç±»å‹ã€‚Lua 5.4åœ¨è¿™æ–¹é¢ä½œå‡ºäº†æ”¹è¿›ï¼Œå¼•å…¥äº†å˜é•¿æ•´æ•°ç±»å‹`varint`ï¼Œå¹¶ä¸”ä¸å†ç›´æ¥ä½¿ç”¨æ¥è‡ªCè¯­è¨€çš„`int`å’Œ`size_t`ç±»å‹ã€‚è¿™æ˜¯Lua 5.4äºŒè¿›åˆ¶æ ¼å¼æœ€æ ¸å¿ƒçš„å˜åŒ–ï¼Œæ‰€ä»¥æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹`varint`ç±»å‹çš„ç¼–ç æ ¼å¼ã€‚



## å˜é•¿æ•´æ•°ç±»å‹

LuaäºŒè¿›åˆ¶å—ä¸­å­˜å‚¨äº†å¾ˆå¤šæ•´æ•°ï¼Œä¾‹å¦‚è°ƒè¯•ç”¨çš„è¡Œå·ã€å­—ç¬¦ä¸²å’Œå„ç§åˆ—è¡¨çš„é•¿åº¦ç­‰ã€‚è¿™äº›æ•´æ•°é€šå¸¸éƒ½å¾ˆå°ï¼Œå› æ­¤ä¸ç®¡ä¸‰ä¸ƒäºŒåä¸€éƒ½å ç”¨å›ºå®šï¼ˆæ¯”å¦‚8ä¸ªï¼‰å­—èŠ‚å°±æœ‰ç‚¹æµªè´¹äº†ã€‚ä¸ºäº†è®©äºŒè¿›åˆ¶å—æ›´ç´§å‡‘ï¼ŒLua 5.4å¼•å…¥äº†å˜é•¿æ•´æ•°ç¼–ç ã€‚æˆ‘ä»¬æ‰€ç†ŸçŸ¥çš„[Protobufåºåˆ—åŒ–æ ¼å¼](https://developers.google.com/protocol-buffers/docs/encoding#varints)ï¼Œä»¥åŠå‰æ–‡æåˆ°çš„[WebAssemblyæ¨¡å—äºŒè¿›åˆ¶æ ¼å¼](https://webassembly.github.io/spec/core/binary/values.html#integers)éƒ½é‡‡ç”¨äº†[LEB128](https://en.wikipedia.org/wiki/LEB128)æ¥ç¼–ç å˜é•¿æ•´æ•°ä»¥ä¾¿èŠ‚çº¦ç©ºé—´ã€‚Lua 5.4é‡‡ç”¨çš„ä¹Ÿæ˜¯ç±»ä¼¼çš„ç¼–ç æ ¼å¼ï¼Œä½†ç•¥æœ‰ä¸åŒï¼Œä¸‹é¢é™„ä¸Šæ ¸å¿ƒçš„è§£ç å‡½æ•°çš„ä»£ç ï¼š

```c
// lua5.4.1/src/lundump.c#L69
static size_t loadUnsigned (LoadState *S, size_t limit) {
  size_t x = 0;
  int b;
  limit >>= 7;
  do {
    b = loadByte(S);
    if (x >= limit)
      error(S, "integer overflow");
    x = (x << 7) | (b & 0x7f);
  } while ((b & 0x80) == 0);
  return x;
}
```

é€šè¿‡é˜…è¯»è§£ç å‡½æ•°å¯çŸ¥ï¼ŒLua 5.4äºŒè¿›åˆ¶å—`varint`ç¼–ç æ ¼å¼å’ŒLEB128ç›¸æ¯”ä¸»è¦æœ‰ä¸¤ç‚¹ä¸åŒã€‚ç¬¬ä¸€ï¼ŒLEB128æ˜¯å°ç«¯å­—èŠ‚åºï¼ŒLuaåˆ™æ˜¯å¤§ç«¯å­—èŠ‚åºã€‚ç¬¬äºŒï¼Œä¸¤ç§ç¼–ç æ ¼å¼éƒ½æ˜¯åˆ©ç”¨å­—èŠ‚çš„MSBï¼ˆMost Significant Bitï¼‰æ¥æ ‡è¯†æ˜¯å¦æœ‰åç»­å­—èŠ‚ï¼Œä¸è¿‡åœ¨LEB128ä¸­MSBä¸º1è¡¨ç¤ºæœ‰åç»­å­—èŠ‚ï¼ŒLuaåˆ™åˆšå¥½ç›¸åã€‚ä¸‹é¢é€šè¿‡ä¸€ä¸ªä¾‹å­æ¥è¯´æ˜LEB128å’ŒLua 5.4äºŒè¿›åˆ¶å—`varint`ç¼–ç æ ¼å¼ä¸Šçš„å·®å¼‚ã€‚

å‡è®¾æœ‰ä¸€ä¸ªæ•´æ•°Nï¼Œå¯ä»¥ç”¨3ä¸ªå­—èŠ‚ï¼ˆ24ä¸ªæ¯”ç‰¹ï¼‰æ¥è¡¨ç¤ºã€‚é‚£ä¹ˆLEB128ç¼–ç çš„ç¬¬ä¸€æ­¥æ˜¯æŠŠè¿™24ä¸ªæ¯”ç‰¹åˆ†ä¸ºå››ç»„ï¼Œæ¯ç»„7ä¸ªæ¯”ç‰¹ã€‚äºæ˜¯3ä¸ªå­—èŠ‚å˜æˆäº†4ä¸ªå­—èŠ‚ï¼Œå‰©ä½™çš„ç©ºé—´è¡¥0ã€‚ç”±äºLEB128æ˜¯å°ç«¯åœ¨å‰ï¼Œæ‰€ä»¥ç¬¬äºŒæ­¥æ˜¯æŠŠä¸Šä¸€æ­¥å¾—åˆ°çš„4ä¸ªå­—èŠ‚åè½¬é¡ºåºã€‚ç¬¬ä¸‰æ­¥æ˜¯è®¾ç½®åè½¬å4ä¸ªå­—èŠ‚çš„MSBï¼Œé™¤æœ€åä¸€ä¸ªå­—èŠ‚å¤–ï¼Œå‰é¢å­—èŠ‚çš„MSBéƒ½è®¾ç½®æˆ1ã€‚ç¼–ç å®Œæ¯•ï¼Œå…·ä½“æ­¥éª¤å¦‚ä¸‹æ‰€ç¤ºï¼š

```
data :          xxxxxxxx yyyyyyyy zzzzzzzz
step1: 00000xxx 0xxxxxyy 0yyyyyyz 0zzzzzzz 
step2: 0zzzzzzz 0yyyyyyz 0xxxxxyy 00000xxx
step3: 1zzzzzzz 1yyyyyyz 1xxxxxyy 00000xxx
```

Lua 5.4äºŒè¿›åˆ¶å—`varint`é‡‡ç”¨å¤§ç«¯å­—èŠ‚åºï¼Œæ‰€ä»¥ä¸Šé¢çš„ç¬¬2æ­¥å°±ä¸éœ€è¦äº†ï¼Œç›´æ¥è®¾ç½®4ä¸ªå­—èŠ‚çš„MSBå³å¯ï¼Œå…·ä½“æ­¥éª¤å¦‚ä¸‹æ‰€ç¤ºï¼š

```
data :          xxxxxxxx yyyyyyyy zzzzzzzz
step1: 00000xxx 0xxxxxyy 0yyyyyyz 0zzzzzzz
step2: 00000xxx 0xxxxxyy 0yyyyyyz 1zzzzzzz
```

å†çœ‹ä¸€ä¸ªæ›´åŠ å…·ä½“çš„ä¾‹å­ï¼Œä¸‹é¢æ˜¯æ•´æ•°300ç¼–ç å‰åçš„äºŒè¿›åˆ¶è¡¨ç¤ºï¼š

```
Binary  : 00000001 00101100
LEB128  : 10101100 00000010
Lua 5.4 : 00000010 10101100
```



## å­—ç¬¦ä¸²å’Œåˆ—è¡¨

å¦‚æœè¦å­˜å‚¨è¿ç»­Nä¸ªç›¸åŒç±»å‹çš„æ•°æ®ï¼Œé€šå¸¸çš„åšæ³•æ˜¯å…ˆè®°å½•æ•°æ®çš„æ•°é‡ï¼Œç„¶åè®°å½•Nä¸ªæ•°æ®ã€‚è¿™ç§ç»“æ„åœ¨Javaç±»æ–‡ä»¶æ ¼å¼ä¸­å«åšè¡¨ï¼ˆTableï¼‰ï¼Œåœ¨WebAssemblyæ¨¡å—äºŒè¿›åˆ¶æ ¼å¼ä¸­å«åšå‘é‡ï¼ˆVectorï¼‰ã€‚Luaæºä»£ç ä¸­å¹¶æ²¡æœ‰ç»™è¿™ç§ç»“æ„æ­£å¼å‘½åï¼Œä¸ºäº†ä¾¿äºæè¿°ï¼Œæœ¬æ–‡ç§°ä¹‹ä¸ºåˆ—è¡¨ï¼ˆListï¼‰ã€‚

æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œ[Javaè™šæ‹Ÿæœºè§„èŒƒ](https://docs.oracle.com/javase/specs/jvms/se15/html/jvms-4.html)å¯¹Javaç±»æ–‡ä»¶æ ¼å¼è¿›è¡Œäº†å®šä¹‰ï¼Œ[WebAssemblyæ ¸å¿ƒè§„èŒƒ](https://webassembly.github.io/spec/core/binary/index.html)å¯¹WebAssemblyæ¨¡å—äºŒè¿›åˆ¶æ ¼å¼è¿›è¡Œäº†å®šä¹‰ã€‚ä¸è¿™äº›ç”±æ ‡å‡†å®šä¹‰çš„æŠ€æœ¯ä¸åŒï¼ŒLuaäºŒè¿›åˆ¶å—æ ¼å¼å®Œå…¨å±äºå®ç°ç»†èŠ‚ï¼Œæ²¡æœ‰ç›¸åº”çš„è§„èŒƒï¼Œä¹Ÿä¸ä¿è¯å‘åå…¼å®¹æ€§ã€‚å› æ­¤LuaäºŒè¿›åˆ¶å—æ ¼å¼æœ€æƒå¨çš„å®šä¹‰å°±æ˜¯Luaå®˜æ–¹å®ç°çš„Cè¯­è¨€æºä»£ç ã€‚ä¸ºäº†ä¾¿äºç†è§£ï¼Œæœ¬æ–‡å°†é‡‡ç”¨ä¸Javaè™šæ‹Ÿæœºè§„èŒƒä¸­æè¿°Javaç±»æ–‡ä»¶æ ¼å¼ç±»ä¼¼çš„è¯­æ³•æ¥æè¿°LuaäºŒè¿›åˆ¶å—æ ¼å¼ã€‚è¿™ç§æè¿°å’ŒCè¯­è¨€ä¸­ç»“æ„ä½“çš„å®šä¹‰å¾ˆåƒï¼Œä¸ºäº†ä¾¿äºå¯¹æ¯”å·®å¼‚ï¼Œæœ¬æ–‡ä¼šåŒæ—¶ç»™å‡ºLua 5.3å’Œ5.4çš„æ ¼å¼æè¿°ã€‚ä¸‹é¢æ˜¯åˆ—è¡¨çš„æ ¼å¼æè¿°ï¼š

```
// Lua 5.3                 | // Lua 5.4
List {                     | List {
  int size_elems;          |   varint size_elems;
  T   elems[size_elems];   |   T      elems[size_elems];
}                          | }
```

å­—ç¬¦ä¸²å¯ä»¥çœ‹ä½œæ˜¯ç‰¹æ®Šçš„åˆ—è¡¨ï¼Œå…ƒç´ ç±»å‹æ˜¯æœ€ç®€å•çš„å­—èŠ‚ã€‚ä½œä¸ºä¼˜åŒ–ï¼ŒLua 5.3äºŒè¿›åˆ¶å—å¯¹å­—ç¬¦ä¸²è¿›è¡Œäº†ç‰¹æ®Šå¤„ç†ï¼Œç¬¬ä¸€ä¸ªå­—èŠ‚èµ·äº†tagçš„ä½œç”¨ã€‚å¯¹äºç©ºå­—ç¬¦ä¸²ï¼ˆNULLï¼‰ï¼Œç›´æ¥å­˜å‚¨å­—èŠ‚0å³å¯ã€‚å¯¹äºé•¿åº¦`L`å°äº255çš„çŸ­å­—ç¬¦ä¸²ï¼Œå…ˆå­˜å‚¨`L - 1`ï¼Œç„¶åå­˜å‚¨`L`ä¸ªå­—èŠ‚ã€‚å¯¹äºé•¿åº¦`L`å¤§äºç­‰äº255çš„é•¿å­—ç¬¦ä¸²ï¼Œå…ˆå­˜å‚¨tagå€¼`255`ï¼Œç„¶åå°†`L`å­˜å‚¨ä¸º`size_t`å‹ï¼Œæœ€åå­˜å‚¨`L`ä¸ªå­—èŠ‚ã€‚ç”±äºLua 5.4å¼•å…¥äº†`varint`ç±»å‹ï¼Œæ‰€ä»¥è¿™ä¸ªä¼˜åŒ–å°±ä¸éœ€è¦äº†ï¼Œä½†æ˜¯ä»ç„¶ä¿ç•™äº†ç©ºå­—ç¬¦ä¸²çš„ä¼˜åŒ–ã€‚ä¸‹é¢æ˜¯å­—ç¬¦ä¸²çš„æ ¼å¼æè¿°ï¼ˆ`union`ç±»å‹ä¸­çš„å­—æ®µåªä¼šå­˜å‚¨ä¸€ä¸ªï¼Œä¸‹åˆ’çº¿è¡¨ç¤ºä¸éœ€è¦å®é™…å­˜å‚¨æ•°æ®ï¼‰ï¼š

```
// Lua 5.3                      | // Lua 5.4
String {                        | String {
  byte size; // tag             |   varint size;
  union {                       |   union {
    // size == 0                |     // size == 0
    _    null;                  |     _    null;
    // size < 255               |     // size > 0
    byte short_str[size - 1];   |     byte str[size - 1];
    // size == 255              |
    {                           | 
      size_t size2;             | 
      byte   str[size2];        | 
    } long_str;                 | 
  } str;                        |   } str;
}                               | }
```



## æ•´ä½“ç»“æ„

ä¸‹é¢æ˜¯LuaäºŒè¿›åˆ¶å—æ ¼å¼çš„æ•´ä½“æè¿°ï¼š

```
// Lua 5.3                      | // Lua 5.4
BinaryChunk {                   | BinaryChunk {
  byte      lua_signature[4];   |   byte      lua_signature[4];
  byte      luac_version;       |   byte      luac_version;
  byte      luac_format;        |   byte      luac_format;
  byte      luac_data[6];       |   byte      luac_data[6];
  byte      int_size;           | 
  byte      sizet_size;         | 
  byte      instruction_size;   |   byte      instruction_size;
  byte      lua_Integer_size;   |   byte      lua_Integer_size;
  byte      lua_Number_size;    |   byte      lua_Number_size;
  byte      luac_int[8];        |   byte      luac_int[8];
  byte      luac_num[8];        |   byte      luac_num[8];
  byte      size_upvalues;      |   byte      size_upvalues;
  Prototype main_func;          |   Prototype main_func;
}                               | }
```

æ•´ä¸ªäºŒè¿›åˆ¶å—åˆ†ä¸ºä¸¤å¤§éƒ¨åˆ†ï¼ŒHeaderå’Œä¸»å‡½æ•°åŸå‹ã€‚Headeré‡Œé¢é¦–å…ˆæ˜¯å¤§éƒ¨åˆ†äºŒè¿›åˆ¶æ ¼å¼éƒ½ä¼šæœ‰çš„é­”æ•°ï¼ˆMagic Numberï¼‰å’Œç‰ˆæœ¬å·ï¼Œç„¶åæ˜¯æ ¼å¼å·ä»¥åŠæ ¡éªŒç”¨çš„6å­—èŠ‚æ•°æ®ï¼Œç„¶åå°±æ˜¯å„ç§åŸºæœ¬æ•°æ®ç±»å‹çš„é•¿åº¦ï¼Œæœ€åæ˜¯ä¸»å‡½æ•°åŸå‹ã€‚å‡½æ•°åŸå‹ï¼ˆPrototypeï¼‰æ˜¯ä¸ªé€’å½’ç»“æ„ï¼Œå› æ­¤æ•´ä¸ªLuaè„šæœ¬éƒ½è¢«ç¼–è¯‘è¿›äº†ç¼–è¯‘å™¨è‡ªåŠ¨ç”Ÿæˆçš„ä¸»å‡½æ•°åŸå‹é‡Œã€‚

å°±æ•´ä½“ç»“æ„è€Œè¨€ï¼Œä¸»è¦æ˜¯ä¸¤å¤„å˜åŒ–ã€‚ç¬¬ä¸€ï¼Œ`luac_version`çš„å€¼ç”±äº`0x53`å˜æˆäº†`0x54`ã€‚ç¬¬äºŒï¼Œç”±äºLua 5.4äºŒè¿›åˆ¶å—æŠ›å¼ƒäº†å¹³å°ç›¸å…³çš„`int`å’Œ`size_t`åŸºæœ¬æ•°æ®ç±»å‹ï¼Œå› æ­¤Headeré‡Œå»æ‰äº†å¯¹äºè¿™ä¸¤ä¸ªåŸºæœ¬æ•°æ®ç±»å‹é•¿åº¦çš„è®°å½•ï¼ˆ`int_size`å’Œ`sizet_size`ï¼‰ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹å‡½æ•°åŸå‹æ ¼å¼çš„å˜åŒ–ã€‚



## å‡½æ•°åŸå‹

ä¸‹é¢æ˜¯å‡½æ•°åŸå‹æ ¼å¼çš„æè¿°ï¼š

```
// Lua 5.3                                   | // Lua 5.4
Prototype {                                  | Prototype {
  String      source;                        |   String      source;
  int         line_defined;                  |   varint      line_defined;
  int         last_line_defined;             |   varint      last_line_defined;
  byte        num_params;                    |   byte        num_params;
  byte        is_vararg;                     |   byte        is_vararg;
  byte        max_stack_size;                |   byte        max_stack_size;
  int         size_code;                     |   varint      size_code;
  Instruction code[size_code];               |   Instruction code[size_code];
  int         size_constants;                |   varint      size_constants;
  Constant    constants[size_constants];     |   Constant    constants[size_constants];
  int         size_upvalues;                 |   varint      size_upvalues;
  Upvalue     upvalues[size_upvalues];       |   Upvalue     upvalues[size_upvalues];
  int         size_protos;                   |   varint      size_protos;
  Prototype   protos[size_protos];           |   Prototype   protos[size_protos];
  int         size_line_info;                |   varint      size_line_info;
  int         line_info[size_line_info];     |   byte        line_info[size_line_info];
                                             |   varint      size_abs_line_info;
                                             |   AbsLineInfo abs_line_info[size_abs_line_info];
  int         size_loc_vars;                 |   varint      size_loc_vars;
  LocVar      loc_vars[size_loc_vars];       |   LocVar      loc_vars[size_loc_vars];
  int         size_upval_names;              |   varint      size_upval_names;
  String      upval_names[size_upval_names]; |   String      upval_names[size_upval_names];
}                                            | }
```

å‡½æ•°åŸå‹æ•°æ®å¯ä»¥åˆ†ä¸º6ä¸ªéƒ¨åˆ†ï¼šåŸºæœ¬ä¿¡æ¯ï¼ˆ`num_params`ã€`is_vararg`å’Œ`max_stack_size`ï¼‰ã€æŒ‡ä»¤åˆ—è¡¨ï¼ˆ`size_code`å’Œ`code`ï¼‰ã€å¸¸é‡åˆ—è¡¨ï¼ˆ`size_constants`å’Œ`constants`ï¼‰ã€Upvalueä¿¡æ¯åˆ—è¡¨ï¼ˆ`size_upvalues`å’Œ`upvalues`ï¼‰ã€å­å‡½æ•°åˆ—è¡¨ï¼ˆ`size_protos`å’Œ`protos`ï¼‰ã€è°ƒè¯•ä¿¡æ¯ï¼ˆå…¶ä»–å­—æ®µï¼‰ã€‚

çœ‹èµ·æ¥å‡½æ•°åŸå‹çš„æ ¼å¼å˜åŒ–æŒºå¤§çš„ï¼Œä½†æ˜¯ä»”ç»†è§‚å¯Ÿçš„è¯å°±å¯ä»¥å‘ç°ä¸»è¦æ˜¯ä¸¤ç‚¹å˜åŒ–ã€‚ç¬¬ä¸€ï¼Œè¡Œå·ã€ä»¥åŠå„ç§åˆ—è¡¨çš„æ•°é‡ï¼Œç”±å®šé•¿çš„`int`ç±»å‹å˜æˆäº†å˜é•¿çš„`varint`ç±»å‹ã€‚å¾ˆæ˜¾ç„¶ï¼Œè¿™å¯ä»¥è®©æ•´ä½“çš„LuaäºŒè¿›åˆ¶å—å˜çš„æ›´åŠ ç´§å‡‘ã€‚ç¬¬äºŒï¼Œè°ƒè¯•ä¿¡æ¯ä¸­çš„`line_info`åˆ—è¡¨å…ƒç´ ç±»å‹ä»`int`å˜æˆäº†`byte`ï¼Œå¦å¤–è¿˜å¢åŠ äº†ä¸€ä¸ª`abs_line_info`åˆ—è¡¨ã€‚å…³äºè°ƒè¯•ä¿¡æ¯çš„æ›´å¤šç»†èŠ‚å°†åœ¨åç»­æ–‡ç« ä¸­ä»‹ç»ï¼Œæ¥ä¸‹æ¥çœ‹çœ‹å¸¸é‡æ¡ç›®çš„æ ¼å¼å˜åŒ–ã€‚



## å¸¸é‡

ç”±äºå¸¸é‡åˆ—è¡¨ä¸­è¦åŒ…å«ä¸åŒç±»å‹çš„å¸¸é‡ï¼ˆ`nil`å€¼ã€å¸ƒå°”å€¼ã€æ•´æ•°å€¼ã€æµ®ç‚¹æ•°å€¼ã€å­—ç¬¦ä¸²ï¼‰ï¼Œå› æ­¤ç›´æ¥ä½¿ç”¨å‰é¢ä»‹ç»çš„åˆ—è¡¨æ˜¯ä¸å¤Ÿçš„ã€‚å¯¹äºç±»å‹ä¸å”¯ä¸€çš„å…ƒç´ ï¼Œé€šå¸¸çš„åšæ³•æ˜¯å…ˆç”¨1å­—èŠ‚çš„tagå­˜å‚¨å…ƒç´ ç±»å‹ï¼Œç„¶åå†å­˜å‚¨å…ƒç´ æ•°æ®ã€‚è§£ç æ—¶ï¼Œå…ˆè¯»å–tagå€¼ï¼Œç„¶åå°±å¯ä»¥çŸ¥é“åé¢è·Ÿç€çš„å…·ä½“æ˜¯ä»€ä¹ˆç±»å‹çš„å…ƒç´ ã€‚Javaç±»æ–‡ä»¶æ ¼å¼å’ŒWebAssemblyæ¨¡å—äºŒè¿›åˆ¶æ ¼å¼ä¹Ÿéƒ½é‡‡ç”¨äº†è¿™ç§åšæ³•ï¼Œä¸‹é¢æ˜¯å¸¸é‡çš„æ ¼å¼æè¿°ï¼š

```
// Lua 5.3                     | // Lua 5.4
Constant {                     | Constant {
  byte tag;                    |   byte tag;
  union {                      |   union {
    _           nil_value;     |     _           nil_value;
                               |     _           false_value;
    byte        bool_value;    |     _           true_value;
    lua_Number  float_value;   |     lua_Number  float_value;
    lua_Integer int_value;     |     lua_Integer int_value;
    String      str_value;     |     String      str_value;
  } value;                     |   } value;
}                              | }
```

å¸¸é‡çš„ç¼–ç æ ¼å¼å˜åŒ–ä¸å¤§ï¼Œä¸»è¦æ˜¯å°†å¸ƒå°”å€¼å†…è”è¿›äº†tagé‡Œã€‚å› æ­¤ï¼Œå½“å¸¸é‡æ± ä¸­åŒ…å«å¸ƒå°”å€¼æ—¶ï¼ŒLua 5.4äºŒè¿›åˆ¶å—åº”è¯¥ä¼šæ¯”5.3ç¨å¾®ç´§å‡‘ä¸€äº›ã€‚ä¸‹è¡¨åˆ—å‡ºäº†tagå€¼ä»¥åŠç›¸å¯¹åº”çš„å¸¸é‡ç±»å‹ï¼š

| Tagå€¼  | å¸¸é‡ç±»å‹ï¼ˆLua 5.3ï¼‰ | å¸¸é‡ç±»å‹ï¼ˆLua 5.4ï¼‰ |
| ------ | ------------------- | ------------------- |
| `0x00` | nil                 | nil                 |
| `0x01` | boolean             | false               |
| `0x11` |                     | true                |
| `0x03` | lua_Number          | lua_Integer         |
| `0x13` | lua_Integer         | lua_Number          |
| `0x04` | short string        | short string        |
| `0x14` | long string         | long string         |

æ¥ä¸‹æ¥çœ‹çœ‹Upvalueæ ¼å¼çš„å˜åŒ–ã€‚



## Upvalueä¿¡æ¯

Upvalueçš„æ ¼å¼å˜åŒ–ä¸å¤§ï¼Œåªæ˜¯å¢åŠ äº†ä¸€ä¸ª`kind`å­—æ®µã€‚åç»­çš„æ–‡ç« å°†è¯¦ç»†ä»‹ç»Upvalueï¼Œè¿™é‡Œä»…ç»™å‡ºäºŒè¿›åˆ¶å—ä¸­Upvalueæ ¼å¼çš„æè¿°ï¼š

```
// Lua 5.3        | // Lua 5.4
Upvalue {         | Upvalue {
  byte instack;   |   byte instack;
  byte idx;       |   byte idx;
                  |   byte kind;
}                 | }
```

æœ€åçœ‹çœ‹è°ƒè¯•ä¿¡æ¯ã€‚



## è°ƒè¯•ä¿¡æ¯

è¡Œå·è¡¨åœ¨å‰é¢å·²ç»è®¨è®ºè¿‡äº†ã€‚LocVarç»“æ„å˜åŒ–ä¸å¤§ï¼Œåªæ˜¯æŠŠPCå€¼ä»`int`ç±»å‹æ”¹æˆäº†`varint`ç±»å‹ï¼Œä¸‹é¢æ˜¯æ ¼å¼æè¿°ï¼š

```
// Lua 5.3           | // Lua 5.4
LocVar {             | LocVar {
  String name;       |   String name;
  int    start_pc;   |   varint start_pc;
  int    end_pc;     |   varint end_pc;
}                    | }
```

LocVaræ²¡ä»€ä¹ˆå¯è¯´çš„ï¼Œæœ€åæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¡Œå·è¡¨çš„å˜åŒ–ã€‚ç»“åˆå‰é¢ç»™å‡ºçš„å‡½æ•°åŸå‹æ ¼å¼å¯çŸ¥ï¼Œåœ¨Lua 5.3äºŒè¿›åˆ¶å—é‡Œï¼Œè¡Œå·è¢«å­˜å‚¨ä¸º`int`åˆ—è¡¨ï¼Œå…¶é•¿åº¦å’ŒæŒ‡ä»¤åˆ—è¡¨çš„é•¿åº¦ç›¸åŒã€‚å¯¹äºæ¯ä¸€æ¡æŒ‡ä»¤ï¼Œéƒ½å¯ä»¥ç›´æ¥åœ¨è¡Œå·è¡¨é‡Œæ‰¾åˆ°å…¶å¯¹åº”çš„è¡Œå·ã€‚åœ¨Lua 5.4äºŒè¿›åˆ¶å—é‡Œï¼Œè¡Œå·è¡¨å˜æˆäº†`byte`åˆ—è¡¨ã€‚å…¶é•¿åº¦è¿˜æ˜¯å’ŒæŒ‡ä»¤è¡¨ä¸€æ ·ï¼Œä½†æ˜¯é‡Œé¢å­˜å‚¨çš„ä¸å†æ˜¯è¡Œå·çš„ç»å¯¹å€¼ï¼Œè€Œæ˜¯å¢é‡å€¼ã€‚ä¸ºäº†é¿å…å¢é‡å€¼è¶…è¿‡`byte`ç±»å‹çš„èŒƒå›´ï¼Œä¹Ÿä¸ºäº†åŠ å¿«è¡Œå·è®¡ç®—ï¼ŒLua 5.4äºŒè¿›åˆ¶å—é‡Œè¿˜å­˜å‚¨äº†é˜¶æ®µæ€§çš„è¡Œå·ç»å¯¹å€¼ï¼Œä¹Ÿå°±æ˜¯AbsLineInfoåˆ—è¡¨ã€‚ä¸‹é¢æ˜¯AbsLineInfoç»“æ„çš„æ ¼å¼æè¿°ï¼š

```
// Lua 5.4
AbsLineInfo {
  varint pc;
  varint line;  
}
```



## æ€»ç»“

ç›¸æ¯”äºLua 5.3ï¼ŒLua 5.4äºŒè¿›åˆ¶å—æ ¼å¼æœ€ä¸»è¦çš„å˜åŒ–æ˜¯å¼•å…¥äº†å˜é•¿æ•´æ•°ç±»å‹ã€‚å˜é•¿æ•´æ•°çš„å¼•å…¥ç›´æ¥å½±å“äº†å­—ç¬¦ä¸²ã€åˆ—è¡¨çš„ç¼–ç æ ¼å¼ã€‚æ­¤å¤–ï¼Œå¸¸é‡å’Œè°ƒè¯•ä¿¡æ¯ç­‰ä¹Ÿå¾—åˆ°äº†ä¼˜åŒ–ã€‚å¯ä»¥é¢„æœŸï¼Œè¿™äº›ä¼˜åŒ–å°†ä¼šä½¿Lua 5.4äºŒè¿›åˆ¶æ ¼å¼å˜å¾—æ›´åŠ ç´§å‡‘ã€‚ä»¥æœ€ç®€å•çš„â€œHello, World!â€è„šæœ¬ä¸ºä¾‹ï¼Œä½¿ç”¨5.3.6ç‰ˆæœ¬çš„`luac`ç¼–è¯‘åå¤§å°ä¸º156å­—èŠ‚ï¼Œä½¿ç”¨5.4.1ç‰ˆæœ¬çš„`luac`ç¼–è¯‘åç¼©å°ä¸º122å­—èŠ‚ã€‚ä½“ç§¯å‡å°äº†çº¦20%ï¼Œè¿˜ä¸é”™ğŸ˜Š

```lua
print("Hello, World!")
```



## å¹¿å‘Š

å¦‚æœè¯»è€…æƒ³è¿›ä¸€æ­¥äº†è§£Lua 5.3çš„å†…éƒ¨å®ç°ç»†èŠ‚ï¼Œå¯ä»¥é˜…è¯»æˆ‘å†™çš„ã€Šè‡ªå·±åŠ¨æ‰‹å®ç°Luaï¼šè™šæ‹Ÿæœºã€ç¼–è¯‘å™¨å’Œæ ‡å‡†åº“ã€‹ä¸€ä¹¦ã€‚å¦‚æœè¯»è€…å¯¹Javaè™šæ‹Ÿæœºæ„Ÿå…´è¶£ï¼Œå¯ä»¥é˜…è¯»æˆ‘å†™çš„ã€Šè‡ªå·±åŠ¨æ‰‹å†™Javaè™šæ‹Ÿæœºã€‹ä¸€ä¹¦ã€‚å¦‚æœè¯»è€…å¯¹WebAssemblyæŠ€æœ¯æ„Ÿå…´è¶£ï¼Œå¯ä»¥å‚è€ƒæˆ‘æœ€æ–°å†™çš„ã€ŠWebAssemblyåŸç†ä¸æ ¸å¿ƒæŠ€æœ¯ã€‹ä¸€ä¹¦ã€‚æƒ³è¦äº†è§£Lua 5.4æ›´å¤šå®ç°ç»†èŠ‚çš„è¯»è€…ï¼Œè¯·ç•™æ„æœ¬ç³»åˆ—çš„åç»­æ–‡ç« ã€‚

![book3](../_images/book3.png)

